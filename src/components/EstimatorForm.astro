---
// Estimator form - all logic handled client-side
import { calculateEstimate } from '@/lib/estimator';

const initialPreview = calculateEstimate({
  projectType: "ai_jumpstart",
  complexity: "mid",
  size: "small",
  speed: "standard",
  addons: []
});
---

<div id="estimator" class="space-y-10">
  <div class="grid gap-10 lg:grid-cols-[2fr_1fr]">
    <form id="estimator-form" class="space-y-8">
      <fieldset class="space-y-4">
        <legend class="text-sm font-semibold uppercase tracking-[0.25em] text-primary-500">
          Project type
        </legend>
        <div class="grid gap-4 md:grid-cols-2">
          <label class="flex cursor-pointer flex-col rounded-3xl border border-primary-500 bg-primary-50 p-4" data-radio="projectType" data-value="ai_jumpstart">
            <span class="text-base font-semibold text-slate-900">AI Jumpstart</span>
            <span class="mt-2 text-sm text-slate-600">2–3 week pilot to test AI chat, RAG, or lightweight automations.</span>
            <input type="radio" name="projectType" value="ai_jumpstart" checked class="sr-only" />
          </label>
          <label class="flex cursor-pointer flex-col rounded-3xl border border-slate-200 bg-white p-4" data-radio="projectType" data-value="automation">
            <span class="text-base font-semibold text-slate-900">Automation Accelerator</span>
            <span class="mt-2 text-sm text-slate-600">Integrations and workflow automation to eliminate repetitive tasks.</span>
            <input type="radio" name="projectType" value="automation" class="sr-only" />
          </label>
          <label class="flex cursor-pointer flex-col rounded-3xl border border-slate-200 bg-white p-4" data-radio="projectType" data-value="mvp">
            <span class="text-base font-semibold text-slate-900">MVP Builder</span>
            <span class="mt-2 text-sm text-slate-600">Ship a lean product with auth, data models, and analytics.</span>
            <input type="radio" name="projectType" value="mvp" class="sr-only" />
          </label>
          <label class="flex cursor-pointer flex-col rounded-3xl border border-slate-200 bg-white p-4" data-radio="projectType" data-value="commerce">
            <span class="text-base font-semibold text-slate-900">Commerce Modules</span>
            <span class="mt-2 text-sm text-slate-600">Private apps, AI merchandising, and fulfillment automations.</span>
            <input type="radio" name="projectType" value="commerce" class="sr-only" />
          </label>
        </div>
      </fieldset>

      <fieldset class="grid gap-6 md:grid-cols-3">
        <div class="space-y-3">
          <legend class="text-sm font-semibold uppercase tracking-[0.25em] text-primary-500">Complexity</legend>
          <div class="space-y-2">
            <label class="flex cursor-pointer flex-col rounded-2xl border border-slate-200 bg-white p-4 transition hover:border-slate-300" data-radio="complexity" data-value="low">
              <span class="text-sm font-semibold text-slate-900">Low</span>
              <span class="text-xs text-slate-600">Single workflow or limited data sources.</span>
              <input type="radio" name="complexity" value="low" class="sr-only" />
            </label>
            <label class="flex cursor-pointer flex-col rounded-2xl border border-primary-500 bg-primary-50 p-4 transition shadow-sm" data-radio="complexity" data-value="mid">
              <span class="text-sm font-semibold text-slate-900">Mid</span>
              <span class="text-xs text-slate-600">Multiple systems or teams involved.</span>
              <input type="radio" name="complexity" value="mid" checked class="sr-only" />
            </label>
            <label class="flex cursor-pointer flex-col rounded-2xl border border-slate-200 bg-white p-4 transition hover:border-slate-300" data-radio="complexity" data-value="high">
              <span class="text-sm font-semibold text-slate-900">High</span>
              <span class="text-xs text-slate-600">Regulated industries or complex integrations.</span>
              <input type="radio" name="complexity" value="high" class="sr-only" />
            </label>
          </div>
        </div>

        <div class="space-y-3">
          <legend class="text-sm font-semibold uppercase tracking-[0.25em] text-primary-500">Size</legend>
          <div class="space-y-2">
            <label class="flex cursor-pointer flex-col rounded-2xl border border-primary-500 bg-primary-50 p-4 transition shadow-sm" data-radio="size" data-value="small">
              <span class="text-sm font-semibold text-slate-900">Small</span>
              <span class="text-xs text-slate-600">Focused scope, 1–2 personas.</span>
              <input type="radio" name="size" value="small" checked class="sr-only" />
            </label>
            <label class="flex cursor-pointer flex-col rounded-2xl border border-slate-200 bg-white p-4 transition hover:border-slate-300" data-radio="size" data-value="medium">
              <span class="text-sm font-semibold text-slate-900">Medium</span>
              <span class="text-xs text-slate-600">Broader scope, 3+ personas.</span>
              <input type="radio" name="size" value="medium" class="sr-only" />
            </label>
          </div>
        </div>

        <div class="space-y-3">
          <legend class="text-sm font-semibold uppercase tracking-[0.25em] text-primary-500">Speed</legend>
          <div class="space-y-2">
            <label class="flex cursor-pointer flex-col rounded-2xl border border-primary-500 bg-primary-50 p-4 transition shadow-sm" data-radio="speed" data-value="standard">
              <span class="text-sm font-semibold text-slate-900">Standard</span>
              <span class="text-xs text-slate-600">Standard cadence with weekly drops.</span>
              <input type="radio" name="speed" value="standard" checked class="sr-only" />
            </label>
            <label class="flex cursor-pointer flex-col rounded-2xl border border-slate-200 bg-white p-4 transition hover:border-slate-300" data-radio="speed" data-value="fast">
              <span class="text-sm font-semibold text-slate-900">Fast</span>
              <span class="text-xs text-slate-600">Accelerated delivery with additional overlap.</span>
              <input type="radio" name="speed" value="fast" class="sr-only" />
            </label>
          </div>
        </div>
      </fieldset>

      <fieldset class="space-y-3">
        <legend class="text-sm font-semibold uppercase tracking-[0.25em] text-primary-500">Add-ons</legend>
        <div class="grid gap-4 md:grid-cols-2">
          <label class="flex cursor-pointer items-center justify-between rounded-2xl border border-slate-200 bg-white p-4" data-addon="design_polish">
            <div>
              <span class="text-sm font-semibold text-slate-900">Design polish</span>
              <span class="ml-2 text-xs text-slate-500">+$800</span>
            </div>
            <input type="checkbox" name="addons" value="design_polish" class="sr-only" />
            <span aria-hidden="true" class="inline-flex h-5 w-5 items-center justify-center rounded-full border border-slate-300 text-transparent">&#x2713;</span>
          </label>
          <label class="flex cursor-pointer items-center justify-between rounded-2xl border border-slate-200 bg-white p-4" data-addon="multi_role_auth">
            <div>
              <span class="text-sm font-semibold text-slate-900">Multi-role auth</span>
              <span class="ml-2 text-xs text-slate-500">+$1,200</span>
            </div>
            <input type="checkbox" name="addons" value="multi_role_auth" class="sr-only" />
            <span aria-hidden="true" class="inline-flex h-5 w-5 items-center justify-center rounded-full border border-slate-300 text-transparent">&#x2713;</span>
          </label>
          <label class="flex cursor-pointer items-center justify-between rounded-2xl border border-slate-200 bg-white p-4" data-addon="payments">
            <div>
              <span class="text-sm font-semibold text-slate-900">Payments &amp; billing</span>
              <span class="ml-2 text-xs text-slate-500">+$1,400</span>
            </div>
            <input type="checkbox" name="addons" value="payments" class="sr-only" />
            <span aria-hidden="true" class="inline-flex h-5 w-5 items-center justify-center rounded-full border border-slate-300 text-transparent">&#x2713;</span>
          </label>
          <label class="flex cursor-pointer items-center justify-between rounded-2xl border border-slate-200 bg-white p-4" data-addon="training">
            <div>
              <span class="text-sm font-semibold text-slate-900">Team training &amp; docs</span>
              <span class="ml-2 text-xs text-slate-500">+$600</span>
            </div>
            <input type="checkbox" name="addons" value="training" class="sr-only" />
            <span aria-hidden="true" class="inline-flex h-5 w-5 items-center justify-center rounded-full border border-slate-300 text-transparent">&#x2713;</span>
          </label>
          <label class="flex cursor-pointer items-center justify-between rounded-2xl border border-slate-200 bg-white p-4" data-addon="integrations">
            <div>
              <span class="text-sm font-semibold text-slate-900">Advanced integrations</span>
              <span class="ml-2 text-xs text-slate-500">+$1,200</span>
            </div>
            <input type="checkbox" name="addons" value="integrations" class="sr-only" />
            <span aria-hidden="true" class="inline-flex h-5 w-5 items-center justify-center rounded-full border border-slate-300 text-transparent">&#x2713;</span>
          </label>
        </div>
      </fieldset>

      <fieldset class="space-y-4 border-t border-slate-200 pt-6">
        <legend class="text-sm font-semibold uppercase tracking-[0.25em] text-primary-500">Your info</legend>
        <p class="text-sm text-slate-600">Enter your details to save the estimate and receive a copy.</p>
        <div class="grid gap-4 md:grid-cols-3">
          <div>
            <label for="est-first-name" class="block text-xs font-medium uppercase tracking-[0.25em] text-slate-400">First Name</label>
            <input id="est-first-name" type="text" name="firstName" required placeholder="First name"
              class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 placeholder:text-slate-400 focus:border-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-200" />
          </div>
          <div>
            <label for="est-last-name" class="block text-xs font-medium uppercase tracking-[0.25em] text-slate-400">Last Name</label>
            <input id="est-last-name" type="text" name="lastName" placeholder="Last name"
              class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 placeholder:text-slate-400 focus:border-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-200" />
          </div>
          <div>
            <label for="est-email" class="block text-xs font-medium uppercase tracking-[0.25em] text-slate-400">Email</label>
            <input id="est-email" type="email" name="email" required placeholder="you@company.com"
              class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 placeholder:text-slate-400 focus:border-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-200" />
          </div>
        </div>
      </fieldset>

      <div id="estimator-error" class="hidden rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-700"></div>
      <div id="estimator-success" class="hidden rounded-2xl border border-primary-500 bg-primary-50 p-4 text-sm text-slate-700">
        <p class="font-semibold text-slate-900">Estimate saved!</p>
        <p class="mt-2">Reference ID <span id="estimator-ref" class="font-mono"></span>. Share this during our call and we'll pick up where you left off.</p>
      </div>

      <button
        type="submit"
        id="estimator-submit-btn"
        class="rounded-full bg-slate-900 px-6 py-3 text-sm font-semibold text-white shadow-sm transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-60"
      >
        Get estimate
      </button>
    </form>

    <aside class="space-y-6 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm shadow-slate-200/60">
      <h3 class="text-lg font-semibold text-slate-900">Estimate preview</h3>
      <p class="text-sm text-slate-600">
        These numbers update as you tweak inputs. Submit to lock in the quote, store it for follow-up, and receive a copy by email.
      </p>
      <dl class="space-y-4 text-sm text-slate-600">
        <div>
          <dt class="text-xs uppercase tracking-[0.25em] text-slate-400">Range</dt>
          <dd id="preview-range" class="text-2xl font-semibold text-slate-900">
            $ {initialPreview.low.toLocaleString()} – ${initialPreview.high.toLocaleString()}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-[0.25em] text-slate-400">Estimated timeline</dt>
          <dd id="preview-timeline" class="text-base font-semibold text-slate-900">{initialPreview.timelineWeeks} weeks</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-[0.25em] text-slate-400">Recommended package</dt>
          <dd id="preview-package" class="text-base font-semibold text-slate-900">AI Jumpstart</dd>
        </div>
      </dl>
    </aside>
  </div>
</div>

<script>
  // Estimator client-side logic
  const basePrice: Record<string, number> = { ai_jumpstart: 6000, automation: 8000, mvp: 15000, commerce: 7000 };
  const complexityFactor: Record<string, number> = { low: 1.0, mid: 1.4, high: 1.9 };
  const sizeFactor: Record<string, number> = { small: 1.0, medium: 1.35 };
  const speedFactor: Record<string, number> = { standard: 1.0, fast: 1.3 };
  const addonPricing: Record<string, number> = { design_polish: 800, multi_role_auth: 1200, payments: 1400, training: 600, integrations: 1200 };
  const projectTimelineBase: Record<string, number> = { ai_jumpstart: 3, automation: 4, mvp: 8, commerce: 4 };
  const packageLabels: Record<string, string> = { ai_jumpstart: "AI Jumpstart", automation: "Automation Accelerator", mvp: "MVP Builder", commerce: "Commerce Modules" };

  function roundHundred(v: number) { return Math.round(v / 100) * 100; }

  function calculate() {
    const form = document.getElementById('estimator-form') as HTMLFormElement;
    const fd = new FormData(form);
    const pt = fd.get('projectType') as string || 'ai_jumpstart';
    const cx = fd.get('complexity') as string || 'mid';
    const sz = fd.get('size') as string || 'small';
    const sp = fd.get('speed') as string || 'standard';
    const addons = fd.getAll('addons') as string[];

    const addonsTotal = addons.reduce((s, a) => s + (addonPricing[a] || 0), 0);
    const raw = basePrice[pt] * complexityFactor[cx] * sizeFactor[sz] * speedFactor[sp] + addonsTotal;
    const low = roundHundred(raw * 0.9);
    const high = roundHundred(raw * 1.2);
    const bt = projectTimelineBase[pt];
    const cd = cx === 'high' ? 2 : cx === 'mid' ? 1 : 0;
    const sa = sp === 'fast' ? -1 : 0;
    const sd = sz === 'medium' ? 1 : 0;
    const weeks = Math.max(2, bt + cd + sd + sa);

    document.getElementById('preview-range')!.textContent = `$ ${low.toLocaleString()} – $${high.toLocaleString()}`;
    document.getElementById('preview-timeline')!.textContent = `${weeks} weeks`;
    document.getElementById('preview-package')!.textContent = packageLabels[pt] || '—';
  }

  // Radio selection styling
  document.querySelectorAll('[data-radio]').forEach((label) => {
    label.addEventListener('click', () => {
      const name = (label as HTMLElement).dataset.radio!;
      document.querySelectorAll(`[data-radio="${name}"]`).forEach((l) => {
        l.classList.remove('border-primary-500', 'bg-primary-50', 'shadow-sm');
        l.classList.add('border-slate-200', 'bg-white');
      });
      label.classList.remove('border-slate-200', 'bg-white');
      label.classList.add('border-primary-500', 'bg-primary-50', 'shadow-sm');
      setTimeout(calculate, 0);
    });
  });

  // Addon toggle styling
  document.querySelectorAll('[data-addon]').forEach((label) => {
    label.addEventListener('click', () => {
      const cb = label.querySelector('input[type="checkbox"]') as HTMLInputElement;
      const indicator = label.querySelector('span[aria-hidden]') as HTMLElement;
      // Toggle happens after click
      setTimeout(() => {
        if (cb.checked) {
          label.classList.remove('border-slate-200', 'bg-white');
          label.classList.add('border-primary-500', 'bg-primary-50');
          indicator.classList.remove('border-slate-300', 'text-transparent');
          indicator.classList.add('border-primary-500', 'bg-primary-500', 'text-white');
        } else {
          label.classList.remove('border-primary-500', 'bg-primary-50');
          label.classList.add('border-slate-200', 'bg-white');
          indicator.classList.remove('border-primary-500', 'bg-primary-500', 'text-white');
          indicator.classList.add('border-slate-300', 'text-transparent');
        }
        calculate();
      }, 0);
    });
  });

  // Form submit
  document.getElementById('estimator-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const fd = new FormData(form);
    const btn = document.getElementById('estimator-submit-btn') as HTMLButtonElement;
    const errorEl = document.getElementById('estimator-error') as HTMLElement;
    const successEl = document.getElementById('estimator-success') as HTMLElement;
    const refEl = document.getElementById('estimator-ref') as HTMLElement;

    const firstName = (fd.get('firstName') as string || '').trim();
    const email = (fd.get('email') as string || '').trim();

    if (!firstName || !email) {
      errorEl.textContent = 'Please enter your name and email.';
      errorEl.classList.remove('hidden');
      successEl.classList.add('hidden');
      return;
    }

    // Calculate current values
    calculate();
    const rangeText = document.getElementById('preview-range')?.textContent || '';
    const timelineText = document.getElementById('preview-timeline')?.textContent || '';

    btn.disabled = true;
    btn.textContent = 'Submitting...';
    errorEl.classList.add('hidden');
    successEl.classList.add('hidden');

    try {
      const res = await fetch('/api/estimate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          firstName,
          lastName: (fd.get('lastName') as string || '').trim(),
          email,
          projectType: fd.get('projectType') || 'ai_jumpstart',
          complexity: fd.get('complexity') || 'mid',
          size: fd.get('size') || 'small',
          speed: fd.get('speed') || 'standard',
          addons: fd.getAll('addons'),
          estimateRange: rangeText,
          timeline: timelineText,
        }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || 'Failed to submit estimate');
      }

      refEl.textContent = data.estimateId || '—';
      successEl.classList.remove('hidden');
      btn.textContent = 'Estimate saved ✓';
    } catch (err: any) {
      errorEl.textContent = err.message || 'Something went wrong. Please try again.';
      errorEl.classList.remove('hidden');
      btn.disabled = false;
      btn.textContent = 'Get estimate';
    }
  });
</script>
